name: Integration Tests for Forks

on:
  repository_dispatch:
    types: [trigger-integration-tests]

jobs:
  build:
    name: Integration Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:

      - name: Set up Go 1.x
        uses: actions/setup-go@v2
        with:
          go-version: ^1.13
        id: go

      - uses: actions/checkout@v2
        with:
          repository: ${{ github.event.client_payload.user }}/${{ github.event.client_payload.repo }}
          ref: ${{ github.event.client_payload.ref }}

      - name: Build
        run: make build

      - name: Unit Test
        run: make test

      - name: Integration Test
        run: make integration-test
        env:
          ENV_VAR: ${{ secrets.ENV_VAR }}

      - name: Upload Log Files
        if: ${{ always() }}
        uses: actions/upload-artifact@v2
        with:
          name: logs
          path: .logs/*.log

      - name: Post Comment
        if: ${{ always() }}
        env:
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
          STATUS: "${{ job.status }}"
        run: |

          PR_NUMBER=${{ github.event.client_payload.pr_number }}
          GITHUB_API="https://api.github.com/repos/$GITHUB_REPOSITORY"
          COMMENT_MAGIC_HEADER='<!--'" Do not edit. This comment was auto-generated>"

          if [[ $STATUS == "success" ]]; then
            MESSAGE="üéâ Integration Tests Ran Successfully on ${{ matrix.os }} ü•≥ü•≥"
          else
            MESSAGE="‚ùå Integration Tests Failed on ${{ matrix.os }}"
          fi

          crl() {
            curl --silent --show-error --location --retry 1 "${@:2}" \
          -H "Accept: application/vnd.github.antiope-preview+json, application/vnd.github.v3+json" \
            "$1"
          }

          auth_crl() {
           crl "$1" -H "authorization: Bearer $GITHUB_TOKEN" "${@:2}"
          }

          # Create a message body by appending a magic header
          # and stripping any starting and ending whitespace from the original message

          MESSAGE_BODY="$(jq -n \
              --arg COMMENT_MAGIC_HEADER "$COMMENT_MAGIC_HEADER" \
              --arg MESSAGE "$MESSAGE" \
              '{ body: ($COMMENT_MAGIC_HEADER + "\n" + ($MESSAGE | sub( "^[\\s\\p{Cc}]+"; "" ) | sub( "[\\s\\p{Cc}]+$"; "" ))) }' \
          )"

          COMMENT_HTML_URL="$(auth_crl "$GITHUB_API/issues/$PR_NUMBER/comments" \
              -X POST \
              -H "Content-Type: application/json" \
              --data "$MESSAGE_BODY" \
            | jq -r '.html_url' )"
          COMMENT_INFO="New comment $COMMENT_HTML_URL was created"
          echo $COMMENT_INFO
